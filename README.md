# milvus_index_reproducibility
Scripts for testing Milvus Binary IVF index reproducibility by performing repeated indexing and searching using **identical index settings and vectors**.

Using these scripts on a 2019 MBP I start to get non-reproducible BIN_IVF indices at around 1.5 million vectors. Submitted an issue on milvus repo to get a better understanding of this reproducibility issue. This repo is mainly for other people to reproduce the issue.

## Setup
`sudo docker compose up -d`
`poetry install`

## Usage

In the script you can set:
* Index params (index_type, metric_type, nlist, nprobe, topk)
* `N_insert_batch_size`: Batch size for vector insertion in to index
* `N_search_batch_size`: Batch size for vector similarity search
* `N_index_rebuild`: Number of times you want to rebuild the index
* `N_same_index_search_repeat`: Number of times you want to repeat the search of all vectors for the same index (to confirm that search results are reproducible for a given index build)
* `single_non_vector_field_collection_vals`: You can give a list of booleans to have single or double non-vector field in the CollectionSchema. The non-reproducible index creation is somehow worsened by having multiple non-vector fields in the Collection Schema.
* `embeddings_per_entity`: At some point, I thought having multiple embeddings with the same identifier field (varchar type, as I use uuids) was to blame for the reproduciblity issue. Dont believe that is the case anymore so no need to modify this.


Can specify the number of vectors to insert in the index and the number of search vectors like so:

`poetry run python run_repeated_tests.py --n_vectors 5e6 --n_vectors_search 3e5 --nprobe 5`

Can also specify a range of index sizes and set NPROBE parameter for BIN_IVF_FLAT index:

`poetry run python run_repeated_tests.py --n_vectors_min 6e5 --n_vectors_max 6e6 --n_vectors_count 6 --n_vectors_search 3e5 --nprobe 5`

After the run is done, you can run the `explore_results.py` script to analyze the latests run.

`poetry run explore_results.py`

Below sample results ran on a Desktop with AMD Ryzen 9 7900X and Ubuntu. Results show that search on rebuilt indices (with same vectors) start to become unreproducible at ~2.5 million vectors (depending on number of Fields in Collection Schema), see cases where `fraction_reproducible_search_on_REBUILT_index`<1.0'. Also note that repeated searches on the same index can give non-reproducible results (see cases where `fraction_reproducible_search_on_SAME_index`<1.0')

`poetry run python run_repeated_tests.py --n_vectors_min 6e5 --n_vectors_max 6e6 --n_vectors_count 6 --n_vectors_search 2e5 --nprobe 5`
`poetry run explore_results.py`

|   n_vec_total |   n_vec_index |   n_vec_search |   n_insert_batch_size |   n_search_batch_size | index_params                                                                                                                     | single_non_vector_field   |   embeddings_per_entity |   number_vectors_per_insert_batch |   number_vectors_per_search_batch |   number_index_rebuild |   number_same_index_search_repeat | results_reproducible   |   fraction_reproducible_search_on_REBUILT_index |   fraction_reproducible_search_on_SAME_index |   Repeat_search_on_SAME_index:MAE_distances_max |   Repeat_search_on_SAME_index:MAE_distances_mean |   Repeat_search_on_SAME_index:MAE_distances_min |   Repeat_search_on_SAME_index:num_vecs_in_topK_in_both_search_-_3 |   Repeat_search_on_SAME_index:num_vecs_in_topK_in_both_search_-_0 |   Repeat_search_on_SAME_index:num_vecs_in_topK_in_both_search_-_1 |   Repeat_search_on_SAME_index:num_vecs_in_topK_in_both_search_-_2 |   Repeat_search_on_REBUILT_indices:MAE_distances_max |   Repeat_search_on_REBUILT_indices:MAE_distances_mean |   Repeat_search_on_REBUILT_indices:MAE_distances_min |   Repeat_search_on_REBUILT_indices:num_vecs_in_topK_in_both_search_-_3 |   Repeat_search_on_REBUILT_indices:num_vecs_in_topK_in_both_search_-_0 |   Repeat_search_on_REBUILT_indices:num_vecs_in_topK_in_both_search_-_1 |   Repeat_search_on_REBUILT_indices:num_vecs_in_topK_in_both_search_-_2 |
|--------------:|--------------:|---------------:|----------------------:|----------------------:|:---------------------------------------------------------------------------------------------------------------------------------|:--------------------------|------------------------:|----------------------------------:|----------------------------------:|-----------------------:|----------------------------------:|:-----------------------|------------------------------------------------:|---------------------------------------------:|------------------------------------------------:|-------------------------------------------------:|------------------------------------------------:|------------------------------------------------------------------:|------------------------------------------------------------------:|------------------------------------------------------------------:|------------------------------------------------------------------:|-----------------------------------------------------:|------------------------------------------------------:|-----------------------------------------------------:|-----------------------------------------------------------------------:|-----------------------------------------------------------------------:|-----------------------------------------------------------------------:|-----------------------------------------------------------------------:|
|        600000 |        400000 |         200000 |                 50000 |                   500 | {'metric_type': 'JACCARD', 'index_type': 'BIN_IVF_FLAT', 'nlist': 1000, 'topk': 3, 'consistency_level': 'Strong', 'nprobe': '5'} | False                     |                       1 |                             50000 |                               500 |                      2 |                                 2 | True                   |                                        1        |                                     1        |                                       0         |                                       0          |                                               0 |                                                            400000 |                                                               nan |                                                               nan |                                                               nan |                                            0         |                                            0          |                                                    0 |                                                                 400000 |                                                                    nan |                                                                    nan |                                                                    nan |
|        600000 |        400000 |         200000 |                 50000 |                   500 | {'metric_type': 'JACCARD', 'index_type': 'BIN_IVF_FLAT', 'nlist': 1000, 'topk': 3, 'consistency_level': 'Strong', 'nprobe': '5'} | True                      |                       1 |                             50000 |                               500 |                      2 |                                 2 | True                   |                                        1        |                                     1        |                                       0         |                                       0          |                                               0 |                                                            400000 |                                                               nan |                                                               nan |                                                               nan |                                            0         |                                            0          |                                                    0 |                                                                 400000 |                                                                    nan |                                                                    nan |                                                                    nan |
|       1680000 |       1480000 |         200000 |                 50000 |                   500 | {'metric_type': 'JACCARD', 'index_type': 'BIN_IVF_FLAT', 'nlist': 1000, 'topk': 3, 'consistency_level': 'Strong', 'nprobe': '5'} | True                      |                       1 |                             50000 |                               500 |                      2 |                                 2 | True                   |                                        1        |                                     1        |                                       0         |                                       0          |                                               0 |                                                            400000 |                                                               nan |                                                               nan |                                                               nan |                                            0         |                                            0          |                                                    0 |                                                                 400000 |                                                                    nan |                                                                    nan |                                                                    nan |
|       1680000 |       1480000 |         200000 |                 50000 |                   500 | {'metric_type': 'JACCARD', 'index_type': 'BIN_IVF_FLAT', 'nlist': 1000, 'topk': 3, 'consistency_level': 'Strong', 'nprobe': '5'} | False                     |                       1 |                             50000 |                               500 |                      2 |                                 2 | True                   |                                        1        |                                     1        |                                       0         |                                       0          |                                               0 |                                                            400000 |                                                               nan |                                                               nan |                                                               nan |                                            0         |                                            0          |                                                    0 |                                                                 400000 |                                                                    nan |                                                                    nan |                                                                    nan |
|       2760000 |       2560000 |         200000 |                 50000 |                   500 | {'metric_type': 'JACCARD', 'index_type': 'BIN_IVF_FLAT', 'nlist': 1000, 'topk': 3, 'consistency_level': 'Strong', 'nprobe': '5'} | True                      |                       1 |                             50000 |                               500 |                      2 |                                 2 | True                   |                                        1        |                                     1        |                                       0         |                                       0          |                                               0 |                                                            400000 |                                                               nan |                                                               nan |                                                               nan |                                            0         |                                            0          |                                                    0 |                                                                 400000 |                                                                    nan |                                                                    nan |                                                                    nan |
|       2760000 |       2560000 |         200000 |                 50000 |                   500 | {'metric_type': 'JACCARD', 'index_type': 'BIN_IVF_FLAT', 'nlist': 1000, 'topk': 3, 'consistency_level': 'Strong', 'nprobe': '5'} | False                     |                       1 |                             50000 |                               500 |                      2 |                                 2 | True                   |                                        1        |                                     1        |                                       0         |                                       0          |                                               0 |                                                            400000 |                                                               nan |                                                               nan |                                                               nan |                                            0         |                                            0          |                                                    0 |                                                                 400000 |                                                                    nan |                                                                    nan |                                                                    nan |
|       3840000 |       3640000 |         200000 |                 50000 |                   500 | {'metric_type': 'JACCARD', 'index_type': 'BIN_IVF_FLAT', 'nlist': 1000, 'topk': 3, 'consistency_level': 'Strong', 'nprobe': '5'} | False                     |                       1 |                             50000 |                               500 |                      2 |                                 2 | False                  |                                        0.560005 |                                     0.58253  |                                       0.0477854 |                                       0.00335729 |                                               0 |                                                            233012 |                                                            144659 |                                                             21387 |                                                               942 |                                            0.0481726 |                                            0.0017161  |                                                    0 |                                                                 312004 |                                                                  76453 |                                                                  11068 |                                                                    475 |
|       3840000 |       3640000 |         200000 |                 50000 |                   500 | {'metric_type': 'JACCARD', 'index_type': 'BIN_IVF_FLAT', 'nlist': 1000, 'topk': 3, 'consistency_level': 'Strong', 'nprobe': '5'} | True                      |                       1 |                             50000 |                               500 |                      2 |                                 2 | True                   |                                        1        |                                     1        |                                       0         |                                       0          |                                               0 |                                                            400000 |                                                               nan |                                                               nan |                                                               nan |                                            0         |                                            0          |                                                    0 |                                                                 400000 |                                                                    nan |                                                                    nan |                                                                    nan |
|       4920000 |       4720000 |         200000 |                 50000 |                   500 | {'metric_type': 'JACCARD', 'index_type': 'BIN_IVF_FLAT', 'nlist': 1000, 'topk': 3, 'consistency_level': 'Strong', 'nprobe': '5'} | False                     |                       1 |                             50000 |                               500 |                      2 |                                 2 | False                  |                                        0.415005 |                                     0.43753  |                                       0.0482015 |                                       0.00443206 |                                               0 |                                                            175012 |                                                            194837 |                                                             28885 |                                                              1266 |                                            0.0465982 |                                            0.0022303  |                                                    0 |                                                                 283006 |                                                                 101470 |                                                                  14866 |                                                                    658 |
|       4920000 |       4720000 |         200000 |                 50000 |                   500 | {'metric_type': 'JACCARD', 'index_type': 'BIN_IVF_FLAT', 'nlist': 1000, 'topk': 3, 'consistency_level': 'Strong', 'nprobe': '5'} | True                      |                       1 |                             50000 |                               500 |                      2 |                                 2 | False                  |                                        0.465005 |                                     0.491275 |                                       0.0454567 |                                       0.00408223 |                                               0 |                                                            196511 |                                                            176376 |                                                             25887 |                                                              1226 |                                            0.0427993 |                                            0.00212471 |                                                    0 |                                                                 293008 |                                                                  92928 |                                                                  13430 |                                                                    634 |
|       6000000 |       5800000 |         200000 |                 50000 |                   500 | {'metric_type': 'JACCARD', 'index_type': 'BIN_IVF_FLAT', 'nlist': 1000, 'topk': 3, 'consistency_level': 'Strong', 'nprobe': '5'} | False                     |                       1 |                             50000 |                               500 |                      2 |                                 2 | False                  |                                        5.5e-05  |                                     1        |                                       0         |                                       0          |                                               0 |                                                            400000 |                                                               nan |                                                               nan |                                                               nan |                                            0.0421908 |                                            0.00756962 |                                                    0 |                                                                     22 |                                                                 345142 |                                                                  52482 |                                                                   2354 |
|       6000000 |       5800000 |         200000 |                 50000 |                   500 | {'metric_type': 'JACCARD', 'index_type': 'BIN_IVF_FLAT', 'nlist': 1000, 'topk': 3, 'consistency_level': 'Strong', 'nprobe': '5'} | True                      |                       1 |                             50000 |                               500 |                      2 |                                 2 | False                  |                                        0.65252  |                                     0.67628  |                                       0.0434963 |                                       0.00253252 |                                               0 |                                                            270513 |                                                            112060 |                                                             16702 |                                                               725 |                                            0.0419931 |                                            0.0013468  |                                                    0 |                                                                 330512 |                                                                  59889 |                                                                   9172 |                                                                    427 |
## Sample results with nlist = nprobe = 1000 

`poetry run python run_repeated_tests.py --n_vectors_index 6e6 --n_vectors_search 2e5 --nprobe 1000`

|                                               | d521146f-6d56-4960-a7e1-e088f4bc309e                                                                                                | 24647056-66d9-4328-b0fe-6b08ef5081b7                                                                                                |
|:----------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------|
| n_vec_total                                   | 5000000                                                                                                                             | 5000000                                                                                                                             |
| n_vec_index                                   | 4800000                                                                                                                             | 4800000                                                                                                                             |
| n_vec_search                                  | 200000                                                                                                                              | 200000                                                                                                                              |
| n_insert_batch_size                           | 50000                                                                                                                               | 50000                                                                                                                               |
| n_search_batch_size                           | 500                                                                                                                                 | 500                                                                                                                                 |
| index_params                                  | {'metric_type': 'JACCARD', 'index_type': 'BIN_IVF_FLAT', 'nlist': 1000, 'topk': 3, 'consistency_level': 'Strong', 'nprobe': '1000'} | {'metric_type': 'JACCARD', 'index_type': 'BIN_IVF_FLAT', 'nlist': 1000, 'topk': 3, 'consistency_level': 'Strong', 'nprobe': '1000'} |
| single_non_vector_field                       | False                                                                                                                               | True                                                                                                                                |
| embeddings_per_entity                         | 1                                                                                                                                   | 1                                                                                                                                   |
| number_vectors_per_insert_batch               | 50000                                                                                                                               | 50000                                                                                                                               |
| number_vectors_per_search_batch               | 500                                                                                                                                 | 500                                                                                                                                 |
| number_index_rebuild                          | 2                                                                                                                                   | 2                                                                                                                                   |
| number_same_index_search_repeat               | 2                                                                                                                                   | 2                                                                                                                                   |
| results_reproducible                          | False                                                                                                                               | False                                                                                                                               |
| fraction_reproducible_search_on_REBUILT_index | 0.90235                                                                                                                             | 0.98352                                                                                                                             |
| fraction_reproducible_search_on_SAME_index    | 0.9933025                                                                                                                           | 0.98852                                                                                                                             |
| Repeat_search_on_SAME_index                   | 0.0                                                                                                                                 | 0.0                                                                                                                                 |
| MAE_distances_max                             |                                                                                                                                     |                                                                                                                                     |
| Repeat_search_on_SAME_index                   | 0.0                                                                                                                                 | 0.0                                                                                                                                 |
| MAE_distances_mean                            |                                                                                                                                     |                                                                                                                                     |
| Repeat_search_on_SAME_index                   | 0.0                                                                                                                                 | 0.0                                                                                                                                 |
| MAE_distances_min                             |                                                                                                                                     |                                                                                                                                     |
| Repeat_search_on_SAME_index                   | 17.0                                                                                                                                | 24.0                                                                                                                                |
| num_vecs_in_topK_in_both_search_-_1           |                                                                                                                                     |                                                                                                                                     |
| Repeat_search_on_SAME_index                   | 1366.0                                                                                                                              | 2318.0                                                                                                                              |
| num_vecs_in_topK_in_both_search_-_2           |                                                                                                                                     |                                                                                                                                     |
| Repeat_search_on_SAME_index                   | 398617.0                                                                                                                            | 397657.0                                                                                                                            |
| num_vecs_in_topK_in_both_search_-_3           |                                                                                                                                     |                                                                                                                                     |
| Repeat_search_on_SAME_index                   | nan                                                                                                                                 | 1.0                                                                                                                                 |
| num_vecs_in_topK_in_both_search_-_0           |                                                                                                                                     |                                                                                                                                     |
| Repeat_search_on_REBUILT_indices              | 0.0                                                                                                                                 | 0.0                                                                                                                                 |
| MAE_distances_max                             |                                                                                                                                     |                                                                                                                                     |
| Repeat_search_on_REBUILT_indices              | 0.0                                                                                                                                 | 0.0                                                                                                                                 |
| MAE_distances_mean                            |                                                                                                                                     |                                                                                                                                     |
| Repeat_search_on_REBUILT_indices              | 0.0                                                                                                                                 | 0.0                                                                                                                                 |
| MAE_distances_min                             |                                                                                                                                     |                                                                                                                                     |
| Repeat_search_on_REBUILT_indices              | 2.0                                                                                                                                 | 1.0                                                                                                                                 |
| num_vecs_in_topK_in_both_search_-_0           |                                                                                                                                     |                                                                                                                                     |
| Repeat_search_on_REBUILT_indices              | 159.0                                                                                                                               | 10.0                                                                                                                                |
| num_vecs_in_topK_in_both_search_-_1           |                                                                                                                                     |                                                                                                                                     |
| Repeat_search_on_REBUILT_indices              | 18475.0                                                                                                                             | 1152.0                                                                                                                              |
| num_vecs_in_topK_in_both_search_-_2           |                                                                                                                                     |                                                                                                                                     |
| Repeat_search_on_REBUILT_indices              | 381364.0                                                                                                                            | 398837.0                                                                                                                            |
| num_vecs_in_topK_in_both_search_-_3           |                                                                                                                                     |                                                                                                                                     |                                    1286 |                                     198702 |

## BIN_FLAT also can be non-reproducible
This seems to be due to Milvus not guaranteeing the order of results that have the same score/distance. Note that in table below, even though only ~94% of results have same vector returned, the mean absolute error(or difference) between the distances of the returned results for two compared cases (e.g. two indices built with same settings and vectors) is 0 (See row titled `Repeat_search_on_REBUILT_indices MAE_distances_max`).  

To run test with 5 million vectors on BIN_FLAT index type (takes ~30mins on my desktop)
`poetry run python bin_flat_reproduciblity_test_run.py --n_vectors_index 5e6 --n_vectors_search 2e5`

To get summary of results run
`poetry run python explore_results.py`

Sample results I got show that:
1. `fraction_reproducible_search_on_SAME_index` : Only ~99% of searches performed on the same index with the same vectors is reproducible (this was 100% on the previous BIN_IVF_FLAT index tests above)
2. `fraction_reproducible_search_on_REBUILT_index` : ~94% of searches performen on two indices built with same parameters and vectors is reproducible (this was ~0% for the BIN_IVF_FLAT index tests above)

|                                               | 102f123d-9322-4cea-aa44-8622abe39903                            |
|:----------------------------------------------|:----------------------------------------------------------------|
| n_vec_total                                   | 5000000                                                         |
| n_vec_index                                   | 4800000                                                         |
| n_vec_search                                  | 200000                                                          |
| n_insert_batch_size                           | 50000                                                           |
| n_search_batch_size                           | 500                                                             |
| index_params                                  | {'metric_type': 'JACCARD', 'index_type': 'BIN_FLAT', 'topk': 3} |
| number_vectors_per_insert_batch               | 50000                                                           |
| number_vectors_per_search_batch               | 500                                                             |
| number_index_rebuild                          | 2                                                               |
| number_same_index_search_repeat               | 2                                                               |
| results_reproducible                          | False                                                           |
| fraction_reproducible_search_on_REBUILT_index | 0.94408                                                         |
| fraction_reproducible_search_on_SAME_index    | 0.9952075                                                       |
| Repeat_search_on_SAME_index                   | 0.0                                                             |
| MAE_distances_max                             |                                                                 |
| Repeat_search_on_SAME_index                   | 0.0                                                             |
| MAE_distances_mean                            |                                                                 |
| Repeat_search_on_SAME_index                   | 0.0                                                             |
| MAE_distances_min                             |                                                                 |
| Repeat_search_on_SAME_index                   | 4                                                               |
| num_vecs_in_topK_in_both_search_-_1           |                                                                 |
| Repeat_search_on_SAME_index                   | 1015                                                            |
| num_vecs_in_topK_in_both_search_-_2           |                                                                 |
| Repeat_search_on_SAME_index                   | 398981                                                          |
| num_vecs_in_topK_in_both_search_-_3           |                                                                 |
| Repeat_search_on_REBUILT_indices              | 0.0                                                             |
| MAE_distances_max                             |                                                                 |
| Repeat_search_on_REBUILT_indices              | 0.0                                                             |
| MAE_distances_mean                            |                                                                 |
| Repeat_search_on_REBUILT_indices              | 0.0                                                             |
| MAE_distances_min                             |                                                                 |
| Repeat_search_on_REBUILT_indices              | 66                                                              |
| num_vecs_in_topK_in_both_search_-_1           |                                                                 |
| Repeat_search_on_REBUILT_indices              | 10783                                                           |
| num_vecs_in_topK_in_both_search_-_2           |                                                                 |
| Repeat_search_on_REBUILT_indices              | 389151                                                          |
| num_vecs_in_topK_in_both_search_-_3           |                                                                 |